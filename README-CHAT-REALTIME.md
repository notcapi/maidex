# Chat en Tiempo Real con Supabase para Maidex

Este documento contiene las instrucciones para configurar el sistema de chat en tiempo real utilizando Supabase.

## Requisitos Previos

1. Cuenta en [Supabase](https://supabase.com)
2. Proyecto creado en Supabase
3. Variables de entorno configuradas en el proyecto

## Configuración de Supabase

### 1. Crear una nueva tabla en Supabase

Accede a tu proyecto en Supabase y crea una nueva tabla llamada `messages` con la siguiente estructura:

```sql
CREATE TABLE messages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  content TEXT NOT NULL,
  is_user BOOLEAN NOT NULL DEFAULT FALSE,
  user_id TEXT,
  conversation_id TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  action TEXT,
  drive_files JSONB,
  file_id TEXT
);

-- Índices para mejorar el rendimiento
CREATE INDEX messages_conversation_id_idx ON messages (conversation_id);
CREATE INDEX messages_created_at_idx ON messages (created_at);
```

### 2. Habilitar Realtime para la tabla

1. En el panel de Supabase, ve a "Database" > "Replication"
2. En la sección "Realtime", haz clic en "Tables"
3. Busca la tabla `messages` y activa "Insert", "Update" y "Delete"
4. Guarda los cambios

### 3. Configurar las variables de entorno

En tu archivo `.env.local`, añade las siguientes variables:

```
NEXT_PUBLIC_SUPABASE_URL=https://tu-proyecto.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=tu-clave-anónima
SUPABASE_SERVICE_KEY=tu-clave-de-servicio
```

Puedes encontrar estos valores en la sección "Settings" > "API" de tu proyecto en Supabase.

## Uso del Hook `useChatStream`

El hook `useChatStream` es el componente principal para interactuar con el sistema de chat en tiempo real.

```typescript
import { useChatStream } from '@/hooks/useChatStream';

function ChatComponent() {
  const { 
    messages, 
    isLoading, 
    error, 
    addMessage 
  } = useChatStream({
    conversationId: 'unique-conversation-id',
    initialMessages: [] // Mensajes iniciales opcionales
  });

  // Enviar un nuevo mensaje
  const sendMessage = (content) => {
    addMessage({
      content,
      isUser: true,
      // Otros campos opcionales...
    });
  };

  return (
    <div>
      {messages.map(msg => (
        <div key={msg.id}>
          {msg.content}
        </div>
      ))}
    </div>
  );
}
```

## Estructura de Mensajes

Cada mensaje tiene la siguiente estructura:

```typescript
type Message = {
  id: number | string;    // ID único del mensaje
  content: string;        // Contenido del mensaje
  isUser: boolean;        // Si fue enviado por el usuario o el asistente
  timestamp: Date;        // Fecha y hora del mensaje
  conversationId?: string; // ID de la conversación
  action?: string;        // Acción asociada al mensaje
  driveFiles?: any[];     // Archivos asociados (para Google Drive)
  fileId?: string;        // ID de archivo específico
};
```

## Endpoint de la API

El endpoint `/api/chat-stream` maneja las operaciones del servidor para el chat:

- `GET /api/chat-stream?conversationId=xyz`: Obtiene todos los mensajes de una conversación
- `POST /api/chat-stream`: Añade un nuevo mensaje a la conversación

## Despliegue en Vercel

Este sistema está diseñado para funcionar perfectamente en Vercel. No se requiere ninguna configuración adicional para el despliegue, solo asegúrate de configurar las variables de entorno en el panel de Vercel.

## Solución de problemas

Si experimentas problemas con la conexión en tiempo real:

1. Verifica que las variables de entorno están correctamente configuradas
2. Comprueba que Realtime está habilitado para la tabla `messages` en Supabase
3. Revisa las políticas de seguridad de Supabase (RLS) si es necesario
4. Consulta los logs de la aplicación para posibles errores 